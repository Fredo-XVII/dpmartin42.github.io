<!DOCTYPE html>
<html lang="en-us">

<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    Home | Wicked Good Data
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    
    <center>
    <img style="max-height: 200px; height: 80%; width: 80%; border-radius: 50%" src="/extras/DanielPMartin.jpeg" align="middle"></a></img>
    </center>
    
    <p>Quantitative Psychology PhD and Data Scientist at McKinsey & Company.</p>
    
    <p>
    
    <div style = "font-size: 30px">
    
    <script>
      emailE = ('dpmartin42@' + 'gmail.com')
	  document.write('<a href="mailto:' + emailE + '"><i class="fa fa-envelope-square"></i></a>')
	</script>
    
    <a href="https://github.com/dpmartin42"><i class="fa fa-github"></i></a>
    
    <a href="http://stackexchange.com/users/2457894/dmartin?tab=accounts"><i class="fa fa-stack-exchange"></i></a>
    
    <a href="http://linkedin.com/in/dpmartin42/"><i class="fa fa-linkedin"></i></a>
    
    </div>
    
  </div>
  

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about.html">About Me</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/blog_roll.html">Blog Roll</a>
        
      
    
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/posts.html">Posts</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/visualizations.html">Visualizations</a>
        
      
    

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2017. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Wicked Good Data</a>
            <small>Website and blog of Daniel P. Martin</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <section class="content">
 
  
  

  <h2>
    <a href="/blogposts/r/imbalanced-classes-part-2">Handling Class Imbalance with R and Caret - Caveats when using the AUC</a>
  </h2>

  <section class="post-date">
    January 03, 2017
  </section>
  
  <p>
  
	<p>In my <a href="http://dpmartin42.github.io/blogposts/r/imbalanced-classes-part-1">last post</a>, I went over how weighting and sampling methods can help to improve predictive performance in the case of imbalanced classes. I also included an applied example with a simulated dataset that used the area under the ROC curve (AUC) as the evaluation metric. In this post, I will go over some issues to keep in mind when using the AUC in the case of imbalanced classes and highlight another metric that is useful to examine: area under the precision-recall curve (AUPRC).</p>

<p>To quickly catch up, essential code from the previous post is below:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w"> </span><span class="c1"># for data manipulation
</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w"> </span><span class="c1"># for model-building
</span><span class="n">library</span><span class="p">(</span><span class="n">DMwR</span><span class="p">)</span><span class="w"> </span><span class="c1"># for smote implementation
</span><span class="n">library</span><span class="p">(</span><span class="n">purrr</span><span class="p">)</span><span class="w"> </span><span class="c1"># for functional programming (map)
</span><span class="n">library</span><span class="p">(</span><span class="n">pROC</span><span class="p">)</span><span class="w"> </span><span class="c1"># for AUC calculations
</span><span class="n">library</span><span class="p">(</span><span class="n">PRROC</span><span class="p">)</span><span class="w"> </span><span class="c1"># for Precision-Recall curve calculations
</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">2969</span><span class="p">)</span><span class="w">

</span><span class="n">imbal_train</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">twoClassSim</span><span class="p">(</span><span class="m">5000</span><span class="p">,</span><span class="w">
                           </span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-25</span><span class="p">,</span><span class="w">
                           </span><span class="n">linearVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w">
                           </span><span class="n">noiseVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">

</span><span class="n">imbal_test</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">twoClassSim</span><span class="p">(</span><span class="m">5000</span><span class="p">,</span><span class="w">
                           </span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-25</span><span class="p">,</span><span class="w">
                           </span><span class="n">linearVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w">
                           </span><span class="n">noiseVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
  
</span><span class="c1"># Set up control function for training
</span><span class="w">
</span><span class="n">ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"repeatedcv"</span><span class="p">,</span><span class="w">
                     </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w">
                     </span><span class="n">repeats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">
                     </span><span class="n">summaryFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twoClassSummary</span><span class="p">,</span><span class="w">
                     </span><span class="n">classProbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Build a standard classifier using a gradient boosted machine
</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">5627</span><span class="p">)</span><span class="w">

</span><span class="n">orig_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
                  </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_train</span><span class="p">,</span><span class="w">
                  </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
                  </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                  </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                  </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span><span class="w">


</span><span class="c1"># Create model weights (they sum to one)
</span><span class="w">
</span><span class="n">model_weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">imbal_train</span><span class="o">$</span><span class="n">Class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Class1"</span><span class="p">,</span><span class="w">
                        </span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">table</span><span class="p">(</span><span class="n">imbal_train</span><span class="o">$</span><span class="n">Class</span><span class="p">)[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w">
                        </span><span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="n">table</span><span class="p">(</span><span class="n">imbal_train</span><span class="o">$</span><span class="n">Class</span><span class="p">)[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w">

</span><span class="c1"># Use the same seed to ensure same cross-validation splits
</span><span class="w">
</span><span class="n">ctrl</span><span class="o">$</span><span class="n">seeds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">orig_fit</span><span class="o">$</span><span class="n">control</span><span class="o">$</span><span class="n">seeds</span><span class="w">

</span><span class="n">weighted_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
                      </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_train</span><span class="p">,</span><span class="w">
                      </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
                      </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                      </span><span class="n">weights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_weights</span><span class="p">,</span><span class="w">
                      </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                      </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span><span class="w">

</span><span class="n">ctrl</span><span class="o">$</span><span class="n">sampling</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"down"</span><span class="w">

</span><span class="n">down_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
                  </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_train</span><span class="p">,</span><span class="w">
                  </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
                  </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                  </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                  </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span><span class="w">

</span><span class="n">ctrl</span><span class="o">$</span><span class="n">sampling</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"up"</span><span class="w">

</span><span class="n">up_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
                </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_train</span><span class="p">,</span><span class="w">
                </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
                </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span><span class="w">

</span><span class="n">ctrl</span><span class="o">$</span><span class="n">sampling</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"smote"</span><span class="w">

</span><span class="n">smote_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
                   </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_train</span><span class="p">,</span><span class="w">
                   </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
                   </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                   </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                   </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span><span class="w">

</span><span class="c1"># Examine results for test set
</span><span class="w">
</span><span class="n">model_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_fit</span><span class="p">,</span><span class="w">
                   </span><span class="n">weighted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weighted_fit</span><span class="p">,</span><span class="w">
                   </span><span class="n">down</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">down_fit</span><span class="p">,</span><span class="w">
                   </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up_fit</span><span class="p">,</span><span class="w">
                   </span><span class="n">SMOTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smote_fit</span><span class="p">)</span></code></pre></div>

<h2 id="issues-with-using-roc-for-imbalanced-classes">Issues with using ROC for imbalanced classes</h2>

<p>While using the AUC as an evaluation metric for classifiers on data with imbalanced classes is a popular choice, it can be a misleading one if you are not careful. Take the following example from <a href="http://pages.cs.wisc.edu/~jdavis/davisgoadrichcamera2.pdf">Davis and Goadrich (2006)</a>. Below we see the model performance for two classifiers on an imbalanced dataset, with the ROC curve on the left and the precision-recall curve on the right. In the left example, the AUC for Curve 1 is reported in the paper as 0.813 and the AUC for Curve 2 is 0.875. So blindly choosing the best AUC value will choose Model 2 as the best. However, the precision-recall curve on the right tells a much different story. Here the area under Curve 1 is 0.513 and for Curve 2 it is 0.038. Due to Curve 1 having much better early retrieval compared to Curve 2, we see this massive discrepancy in the precision and recall performance between the two classifiers.</p>

<center><img src="/figs/2017-01-03-imbalanced-classes-part-2/roc_pr_compare.png" /></center>

<p>Another example of how the ROC curve can be misleading comes from <a href="http://people.inf.elte.hu/kiss/11dwhdm/roc.pdf">Fawcett (2005)</a>. Here, we have two datasets, one that has perfect balance between two classes (1:1) and the other has moderate imbalance (10:1). The column on the left shows the ROC curves of two classifiers for both datasets being identical, with the classifier represented by the dashed line having better early retrieval than the classifier represented by the solid line. Again, the precision-recall curve displayed on the right highlights a large discrepancy in performance between the two classifiers on the two datasets. In the case of balanced classes, both classifiers have consistently good precision and recall performance across all thresholds. On the imbalanced data, however, the classifier with better early retrieval has much better precision for lower values of recall.</p>

<center><img src="/figs/2017-01-03-imbalanced-classes-part-2/roc_pr_balance_imbalance.png" /></center>

<p>For these reasons, <a href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0118432">Saito and Rehmsmeier (2015)</a> recommend examining the precision-recall curve as it is more explicitly informative than a ROC curve in the case of imbalanced classes. We can calculate the area under the precision-recall curve for our 5 classifiers using the PRROC package in R to create a custom function, <code>calc_auprc</code>. Here, we see a similar story to what was found with the AUC metric in the <a href="http://dpmartin42.github.io/blogposts/r/imbalanced-classes-part-1">last blog post</a>; we have better performance for the weighted model, followed by the sampled models, with the original model coming in last. However, now the difference in performance is much more apparent.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">calc_auprc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">){</span><span class="w">
  
  </span><span class="n">index_class2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">Class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Class2"</span><span class="w">
  </span><span class="n">index_class1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">Class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Class1"</span><span class="w">
  
  </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"prob"</span><span class="p">)</span><span class="w">
  
  </span><span class="n">pr.curve</span><span class="p">(</span><span class="n">predictions</span><span class="o">$</span><span class="n">Class2</span><span class="p">[</span><span class="n">index_class2</span><span class="p">],</span><span class="w">
           </span><span class="n">predictions</span><span class="o">$</span><span class="n">Class2</span><span class="p">[</span><span class="n">index_class1</span><span class="p">],</span><span class="w"> </span><span class="n">curve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
  
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Get results for all 5 models
</span><span class="w">
</span><span class="n">model_list_pr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">model_list</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">map</span><span class="p">(</span><span class="n">calc_auprc</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_test</span><span class="p">)</span><span class="w">

</span><span class="n">model_list_pr</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">map</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">the_mod</span><span class="p">)</span><span class="w"> </span><span class="n">the_mod</span><span class="o">$</span><span class="n">auc.integral</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## $original
## [1] 0.5271963
## 
## $weighted
## [1] 0.6463645
## 
## $down
## [1] 0.6293265
## 
## $up
## [1] 0.6459151
## 
## $SMOTE
## [1] 0.6195916</code></pre></div>

<p>We can dig deeper into these results by actually plotting the precision-recall curves. Below, we see that both up sampling and weighting offer the best precision and recall performance depending on the threshold that is chosen, while the original classifier is essentially the worst performing across all thresholds. For example, the weighted classifier simultaneously has a recall of 75% and a precision of 50%, resulting in an F1 score of 0.6, while the original classifier has a recall of 75% and a precision of 25%, resulting in an F1 score of 0.38. In other words, when both classifiers create their predictions and use a particular threshold to obtain hard classifications, they both correctly identify 75% of the cases that are actually in the minority class. However, the weighted classifier is more efficient in these predictions, in that 50% of the observations predicted to be in the minority class actually are, while for the original classifier, only 25% of the observations predicted to be in the minority class actually are.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Plot the AUPRC curve for all 5 models
</span><span class="w">
</span><span class="n">results_list_pr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kc">NA</span><span class="p">)</span><span class="w">
</span><span class="n">num_mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">

</span><span class="k">for</span><span class="p">(</span><span class="n">the_pr</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">model_list_pr</span><span class="p">){</span><span class="w">
  
  </span><span class="n">results_list_pr</span><span class="p">[[</span><span class="n">num_mod</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_frame</span><span class="p">(</span><span class="n">recall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_pr</span><span class="o">$</span><span class="n">curve</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w">
                                           </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">the_pr</span><span class="o">$</span><span class="n">curve</span><span class="p">[,</span><span class="w"> </span><span class="m">2</span><span class="p">],</span><span class="w">
                                           </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">model_list_pr</span><span class="p">)[</span><span class="n">num_mod</span><span class="p">])</span><span class="w">
  
  </span><span class="n">num_mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">num_mod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
  
</span><span class="p">}</span><span class="w">

</span><span class="n">results_df_pr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bind_rows</span><span class="p">(</span><span class="n">results_list_pr</span><span class="p">)</span><span class="w">

</span><span class="n">custom_col</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#000000"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#009E73"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#0072B2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#D55E00"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#CC79A7"</span><span class="p">)</span><span class="w">

</span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recall</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">precision</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results_df_pr</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_color_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">custom_col</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_abline</span><span class="p">(</span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">imbal_test</span><span class="o">$</span><span class="n">Class</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Class2"</span><span class="p">)</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">imbal_test</span><span class="p">),</span><span class="w">
              </span><span class="n">slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gray"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme_bw</span><span class="p">()</span></code></pre></div>

<p><img src="/figs/2017-01-03-imbalanced-classes-part-2/unnamed-chunk-3-1.png" alt="center" /></p>

<h2 id="implementing-the-area-under-the-precision-recall-curve-metric-in-caret">Implementing the area under the precision-recall curve metric in caret</h2>

<p>One might imagine wanting to choose hyperparameters of a classifier by using the area under the precision-recall curve rather than the AUC, as some combinations of hyperparameters for a given model might have better early retrieval performance compared to others. It is incredibly easy to create a custom summary function in caret to allow you to do this by combining the code for the <code>calc_auprc</code> function with <a href="https://topepo.github.io/caret/model-training-and-tuning.html#metrics">these instructions</a> found in the caret documentation.</p>

<p>This custom summary function is implemented below, along with code to re-run the original model now using area under the precision-recall curve as the evaluation metric. Here, we see that the original model implementation has the exact same results on the test set for the area under the PR curve, regardless of whether we build the model using the area under the ROC curve or the area under the precision-recall curve. This is because both select the same combination of hyperparameters to build the final model on. Note that this may not always be the case, especially if you decide to use the <a href="http://www.stat.cmu.edu/~ryantibs/datamining/lectures/19-val2-marked.pdf">1-SE</a> rule when choosing the hyperparameters in order to encourage a more parsimonious solution.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">auprcSummary</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">lev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">){</span><span class="w">
  
  </span><span class="n">index_class2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">obs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Class2"</span><span class="w">
  </span><span class="n">index_class1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">obs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Class1"</span><span class="w">
  
  </span><span class="n">the_curve</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pr.curve</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">Class2</span><span class="p">[</span><span class="n">index_class2</span><span class="p">],</span><span class="w">
                        </span><span class="n">data</span><span class="o">$</span><span class="n">Class2</span><span class="p">[</span><span class="n">index_class1</span><span class="p">],</span><span class="w"> </span><span class="n">curve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
  
  </span><span class="n">out</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">the_curve</span><span class="o">$</span><span class="n">auc.integral</span><span class="w">
  </span><span class="nf">names</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"AUPRC"</span><span class="w">
  
  </span><span class="n">out</span><span class="w">
  
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Re-initialize control function to remove smote and
# include our new summary function
</span><span class="w">
</span><span class="n">ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"repeatedcv"</span><span class="p">,</span><span class="w">
                     </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w">
                     </span><span class="n">repeats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">
                     </span><span class="n">summaryFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auprcSummary</span><span class="p">,</span><span class="w">
                     </span><span class="n">classProbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                     </span><span class="n">seeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig_fit</span><span class="o">$</span><span class="n">control</span><span class="o">$</span><span class="n">seeds</span><span class="p">)</span><span class="w">

</span><span class="n">orig_pr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">Class</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w">
                 </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_train</span><span class="p">,</span><span class="w">
                 </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gbm"</span><span class="p">,</span><span class="w">
                 </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
                 </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AUPRC"</span><span class="p">,</span><span class="w">
                 </span><span class="n">trControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get results for auprc on the test set
</span><span class="w">
</span><span class="n">orig_fit_test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">orig_fit</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">calc_auprc</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_test</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">the_mod</span><span class="p">)</span><span class="w"> </span><span class="n">the_mod</span><span class="o">$</span><span class="n">auc.integral</span><span class="p">)</span><span class="w">

</span><span class="n">orig_pr_test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">orig_pr</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">calc_auprc</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imbal_test</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">the_mod</span><span class="p">)</span><span class="w"> </span><span class="n">the_mod</span><span class="o">$</span><span class="n">auc.integral</span><span class="p">)</span><span class="w">

</span><span class="c1"># The test errors are the same
</span><span class="w">
</span><span class="n">identical</span><span class="p">(</span><span class="n">orig_fit_test</span><span class="p">,</span><span class="w">
          </span><span class="n">orig_pr_test</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## [1] TRUE</code></pre></div>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># Because both chose the same
# hyperparameter combination
</span><span class="w">
</span><span class="n">identical</span><span class="p">(</span><span class="n">orig_fit</span><span class="o">$</span><span class="n">bestTune</span><span class="p">,</span><span class="w">
          </span><span class="n">orig_pr</span><span class="o">$</span><span class="n">bestTune</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">## [1] TRUE</code></pre></div>

<h2 id="final-thoughts">Final thoughts</h2>

<p>The area under the precision-recall curve can be a useful metric to help differentiate between two competing models in the case of imbalanced classes. For the AUC, weights and sampling techniques may only provide modest improvements. However, this improvement typically impacts early retrieval performance, resulting in a much larger gain in the overall precision of a model. In conjunction with trying weighting or sampling, it is also recommended to avoid relying solely on the AUC when evaluating the performance of a classifier that has imbalanced classes as it can be a misleading metric. The code above shows how easy it is to use the precision-recall curve, a more sensitive measure of classification performance when there are imbalanced classes.</p>

<p><strong>edit (1/3/17):</strong> Graciously pointed out to me by Max Kuhn, a recent release of caret allows you to use the <code>prSummary</code> function rather than a custom function in <code>trainControl</code> to calculate the area under the precision-recall curve. Additionally, the <code>confusionMatrix</code> function has a mode argument that will focus on precision and recall (rather than sensitivity and specificity). See <a href="https://topepo.github.io/caret/measuring-performance.html">this page</a> for more information.</p>

  
  <hr>

  <!-- Bio here -->
  <section class="meta">
    <h3>About</h3>
    <section class="copy">

      <p>
        I am a data scientist for Organizational Solutions at McKinsey & Company, interested in
        statistics, data mining/machine learning, education, and open science, among other things. 
        All opinions and views are my own and do not represent my employer. 
      </p>
      
      
      
      <a href="/blogposts/r/imbalanced-classes-part-2#disqus_thread">Comments</a>

    </section>
    
    <p>


</section>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53291521-1', 'auto');
  ga('send', 'pageview');

</script>  
    
  </body>
</html>
