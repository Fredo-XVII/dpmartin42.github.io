<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta charset="utf-8">
  <title>
    
      Speeding up data cleaning with dplyr
    
    | Daniel P. Martin
  </title>

  <meta name="author" content="Dan Martin" />
  <meta name="description" content="This is the academic website and blog of Daniel P. Martin" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="images/rotunda.ico">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
  <link media="only screen and (max-device-width: 480px)" href="/css/mobile.css" type="text/css" rel="stylesheet" />
  <link media="only screen and (device-width: 768px)" href="/css/mobile.css" type="text/css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript" src="/js/application.js"></script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</head>

<body>
  <section class="sidebar">
    <a href="/">
      <img src="http://dpmartin42.github.io/images/hobbes.png" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span id="fname">Dan</span>
        <span id="lname">Martin</span>
      </a>
    </section>
    


    <section class="meta">
      <script>
      emailE = ('dpmartin42@' + 'gmail.com')
	  document.write('<a href="mailto:' + emailE + '" target="_blank"><i class="fa fa-envelope-square"></i></a>')
	  </script>
      <a href="https://github.com/dpmartin42" target="_blank"><i class="fa fa-github"></i></a>
      <a href="http://stackexchange.com/users/2457894/dmartin?tab=accounts" target="_blank"><i class="fa fa-stack-exchange"></i></a>
      <a href="http://linkedin.com/in/dpmartin42/" target="_blank"><i class="fa fa-linkedin"></i></a>
	  
    </section>

    <section class="sections">
      <ul>
        <li><a href="/posts.html">Posts</a></li>
        <li><a href="/visualizations.html">Visualizations</a></li>
        <li><a href="/about.html">About</a></li>
        <li><a href="/research.html">Research</a></li>
        <li><a href="/academics.html">Academics</a></li>
        <li><a href="/teaching.html">Teaching</a></li>
        <li><a href="/links.html">Links</a></li>
        <li><a href="/vita.html">Vita</a></li>

      </ul>
    </section>
  </section>

  <section class="content">

<h1>Wicked Good Data</h1>

<p style="border: 2px solid #333"></p>

  <h2>
    <a href="/posts/dplyr-IAT">Speeding up data cleaning with dplyr</a>
  </h2>

  <section class="byline">
    October  1, 2014
  </section>

  <p>About a year and a half ago, I wanted to get some experience creating an R package and putting it on CRAN. I spend some time working with Brian Nosek (see our Crowdsourcing Data Analysis project <a href="https://osf.io/gvm2z/">here</a>), who has helped develop a scoring algorithm for the Implicit Association Test (IAT). While this cleaning algorithm was already implemented in SPSS and SAS, it did not have an R counterpart. Sure enough, this is what I decided to work on.</p>

<p>Now, data from <a href="https://implicit.harvard.edu/implicit/">ProjectImplicit</a> can be fairly large, with the number of participants easily in the hundreds of thousands, if not millions. Because the IAT measures reaction times, these datasets are time series in long format. So, when I started thinking of ways to do quick aggregation in R in order to stay competetive with the SAS and SPSS alternatives, my mind immediately went to data.table. At this time, data.table was blowing everything out of the water. It took some time, and sure enough it was put on CRAN, and was had decent speed considering it was R (it was a little bit slower than SAS).</p>

<p>Just as a quick aside, <a href="http://www.rdocumentation.org/packages/IAT">rdocumentation.org</a> is a great website to use to keep track of CRAN downloads and identify popular R packages that you might not be using.</p>

<p>Anyway, back to business. Ever since I put the IAT package on CRAN, I have been keeping an eye out for packages that I could use to speed things up even more. Coming from using plyr and other tools made by Hadley Wickham, I naturally heard about dplyr a few months back, and started using it. Spoiler alert: it’s great. I find dplyr to be much more intuitive for cleaning data than something like data.table. Now, data.table is still a great package (I use the fread() function all the time to quickly read in data), but you only see substantial improvements in speed if you use it the “data.table way.” For me, it’s much easier to get dplyr right the first time. So, even though data.table might be faster if used correctly, I decided to see if I could get speed improvements in the IAT package by making the switch (there are a ton of other benchmarks for this, see <a href="http://www.r-statistics.com/2013/09/a-speed-test-comparison-of-plyr-data-table-and-dplyr/">here</a> and <a href="http://www.brodieg.com/?p=7">here</a> for a few).</p>

<p>The great thing is that it only took me about an hour or so to convert the code over to dplyr. Let’s benchmark this updated function using dplyr to see if it’s an improvement over my old code. For this benchmark, we will be using sample IAT data included in the IAT package (N = 49, number of rows = 6566), and I replicated each function 100 times</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># install if necessary</span>
<span class="c1"># install.packages(&quot;IAT&quot;)</span>

<span class="kn">require</span><span class="p">(</span>dplyr<span class="p">)</span>
<span class="kn">require</span><span class="p">(</span>IAT<span class="p">)</span>
<span class="kn">require</span><span class="p">(</span>rbenchmark<span class="p">)</span>

myData <span class="o">&lt;-</span> IATData<span class="p">[</span>IATData<span class="o">$</span>isCongruentFirst <span class="o">==</span> <span class="m">1</span><span class="p">,</span> <span class="p">]</span>

benchmark<span class="p">(</span>replications <span class="o">=</span> <span class="m">100</span><span class="p">,</span>
          
  old_way <span class="o">=</span> cleanIAT<span class="p">(</span>
    myData <span class="o">=</span> myData<span class="p">,</span>
    blockName <span class="o">=</span> <span class="s">&quot;BLOCK_NAME_S&quot;</span><span class="p">,</span>
    trialBlocks <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;BLOCK2&quot;</span><span class="p">,</span> <span class="s">&quot;BLOCK3&quot;</span><span class="p">,</span> <span class="s">&quot;BLOCK5&quot;</span><span class="p">,</span> <span class="s">&quot;BLOCK6&quot;</span><span class="p">),</span>
    sessionID <span class="o">=</span> <span class="s">&quot;SESSION_ID&quot;</span><span class="p">,</span>
    trialLatency <span class="o">=</span> <span class="s">&quot;TRIAL_LATENCY&quot;</span><span class="p">,</span>
    trialError <span class="o">=</span> <span class="s">&quot;TRIAL_ERROR&quot;</span><span class="p">,</span>
    vError <span class="o">=</span> <span class="m">1</span><span class="p">,</span> vExtreme <span class="o">=</span> <span class="m">2</span><span class="p">,</span> vStd <span class="o">=</span> <span class="m">1</span><span class="p">),</span>
  
  new_way <span class="o">=</span> cleanIAT_NEW<span class="p">(</span>
    myData <span class="o">=</span> myData<span class="p">,</span>
    blockName <span class="o">=</span> <span class="s">&quot;BLOCK_NAME_S&quot;</span><span class="p">,</span>
    trialBlocks <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;BLOCK2&quot;</span><span class="p">,</span> <span class="s">&quot;BLOCK3&quot;</span><span class="p">,</span> <span class="s">&quot;BLOCK5&quot;</span><span class="p">,</span> <span class="s">&quot;BLOCK6&quot;</span><span class="p">),</span>
    sessionID <span class="o">=</span> <span class="s">&quot;SESSION_ID&quot;</span><span class="p">,</span>
    trialLatency <span class="o">=</span> <span class="s">&quot;TRIAL_LATENCY&quot;</span><span class="p">,</span>
    trialError <span class="o">=</span> <span class="s">&quot;TRIAL_ERROR&quot;</span><span class="p">,</span>
    vError <span class="o">=</span> <span class="m">1</span><span class="p">,</span> vExtreme <span class="o">=</span> <span class="m">2</span><span class="p">,</span> vStd <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
  
          <span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-text" data-lang="text">##      test replications elapsed relative user.self sys.self user.child
## 2 new_way          100   16.15    1.000     13.57    0.136          0
## 1 old_way          100   33.18    2.055     29.56    0.301          0
##   sys.child
## 2         0
## 1         0</code></pre></div>

<p>Woah, the time was cut in half! I’m sure this could be sped up even more with a better implementation of data.table, but I’m happy with the result for now.</p>

<p>Now, the one issue I had with dplyr is passing variables as strings to dplyr functions. While there are ways to do this (see <a href="https://groups.google.com/forum/#!topic/manipulatr/cr9PzNEtz6w">here</a> for more info), it seemed like too much of a pain to implement given I only really have three variables to pass as strings, but about dozen lines that need these variables. So as a kludgy workaround, I renamed these three variables in the beginning. Voila! Problem solved. Making this easier is on Hadley’s long term to-do list, so I imagine I’ll make the change when such a solution becomes available.</p>

<p>You can get access to this quicker function in the development version of the IAT package on my <a href="https://github.com/dpmartin42/IAT">GitHub</a> using devtools. See the code below for installation instructions:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># install devtools if necessary</span>
<span class="c1"># install.packages(&quot;devtools&quot;)</span>

<span class="kn">require</span><span class="p">(</span>devtools<span class="p">)</span>

install_github<span class="p">(</span>repo <span class="o">=</span> <span class="s">&quot;IAT&quot;</span><span class="p">,</span> username <span class="o">=</span> <span class="s">&quot;dpmartin42&quot;</span><span class="p">)</span></code></pre></div>


  
  <hr>

  <!-- Bio here -->
  <section class="meta">
    <h3>About</h3>
    <section class="copy">

      <p>
        I am a quantitative psychology graduate student at the University of Virginia, interested in
        data analysis, visualization, and meta-science, among other things. While the title of my blog is
        an homage to where I grew up, there is no guarantee that it will be "wicked good."   
      </p>
      
          <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'dpmartin42githubio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53291521-1', 'auto');
  ga('send', 'pageview');

</script>

    </section>
  </section>
</section>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53291521-1', 'auto');
  ga('send', 'pageview');

</script>
  
</body>

</html>
